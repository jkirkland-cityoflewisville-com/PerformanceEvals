<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">

    <title>Evaluation</title>
    <link rel="apple-touch-icon" sizes="180x180" href="../icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../icons/favicon-16x16.png">
    <link rel="manifest" href="../icons/site.webmanifest">
    <link rel="mask-icon" href="../icons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="../icons/favicon.ico">
    <meta name="msapplication-TileColor" content="#603cba">
    <meta name="msapplication-config" content="../icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!--Fonts-->
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

    <!--VueJS-->
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    
    <!-- axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <!--Security-->
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="../oauth/colsecurity.js""></script>

    <style>
        [v-cloak] {display: none}
        iframe {width:100%; height: calc(100vh - 250px);}
        table td{padding-top: 8px; padding-bottom: 8px;}
    </style>
</head>

<body style="background-color:whitesmoke;">
    
    <div id="app" v-cloak>
        <div class="navbar">
            <nav>
                <div class="nav-wrapper deep-purple white-text">
                    <a class="brand-logo">&nbsp Evaluation</a>
                </div>
            </nav>       
        </div> <!--end navbar-->
       
        <!--Username-->
        <div class="row">
            <div class="col s12">
                {{(username.length == 0 ? "Getting username..." : username)}}
            </div>
        </div>
        

        <div class="main white" style="margin-left:1em; margin-right:1em; border:solid 1px black;">     
            
            <div class="row">                
                
                <div class="col m5 s12" style="overflow-y:scroll;">
                    
                    <!--Employee-Input Form-->
                    <h4>Employee Input Form</h4>
                    <table style="margin-left: 1em; font-size:0.8em;">
                        <tr><td><b>Eval Period: Start</b></td><td><b>Eval Period: End</b></td></tr>
                        <tr><td>{{employeeInput.Evaluation_Period_Start_Date}}</td><td>{{employeeInput.Evaluation_Period_End_Date}}</td></tr>

                        <tr><td colspan="2"><b>Question_Accomplishments_Past_Review_Period</b></td></tr>
                        <tr><td colspan="2">{{employeeInput.Question_Accomplishments_Past_Review_Period}}</td></tr>

                        <tr><td colspan="2"><b>Question_Strengths_Opportunities</b></td></tr>
                        <tr><td colspan="2">{{employeeInput.Question_Strengths_Opportunities}}</td></tr>

                        <tr><td colspan="2"><b>Question_Suggestions_Or_Comments</b></td></tr>
                        <tr><td colspan="2">{{employeeInput.Question_Suggestions_Or_Comments}}</td></tr>

                        <tr><td colspan="2"><b>Question_What_Can_City_Do</b></td></tr>
                        <tr><td colspan="2">{{employeeInput.Question_What_Can_City_Do}}</td></tr>

                        <tr><td colspan="2"><b>Question_Work_Challenges</b></td></tr>
                        <tr><td colspan="2">{{employeeInput.Question_Work_Challenges}}</td></tr>
                    </table>
                    <br>

                    <!--Supervisor Logs-->
                    <h4>Supervisor Logs</h4>                    
                    <table style="margin-left: 1em; font-size:0.8em;">
                        <thead>
                            <tr>
                                <th>Incident Date</th>
                                <th>Type</th>
                                <th>Narrative</th>
                                <th>Last Edit: User</th>
                                <th>Last Edit: Date</tH>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="_log in supervisorLogs">
                                <td>{{_log.Incident_Date}}</td>
                                <td>{{_log.Log_Entry_Type}}</td>
                                <td>{{_log.Log_Entry_Text}}</td>
                                <td>{{_log.LastEditUser}}</td>
                                <td>{{_log.LastEditDate}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!--Evaluation-->
                <div class="col m7 s12" style="border-left: solid 1px black;">
                    <h4>Evaluation</h4>
                    <iframe :src="url_Eval"></iframe>
                </div>

            </div>

        </div> <!--end container-->

    </div>  <!--end app-->

    <!--=======================================================-->
    <!--Javascript-->
    <!--=======================================================-->
    <script>
        "use strict"

        var app = new Vue({
            el: "#app",
            data: {                
                username: "",
                evalId: "",
                employeeInputId: "",
                employeeInput: [],
                urlTemplate_Eval: "http://apps.cityoflewisville.com/gitlocal/christina/psofia_v2/formentry/index.html?formID=87&recordNumber={{recordNumber}}",
                url_Eval: "",
                urlTemplate_SA: "http://apps.cityoflewisville.com/gitlocal/christina/psofia_v2/formentry/index.html?formID=86&recordNumber={{recordNumber}}",
                url_SA: "",
                supervisorLogs: [],
                noRecordsFound: false,
                recordsAreLoading: false
            },
            methods: {

                init: function(){
                    var _this = this

                    //Oauth
                    setTimeout(function(){
                        _this.username = localStorage.colEmail
                    },1500)
                    
                    //Evaluation Id
                    _this.evalId = _this.getUrlParameter("recordNumber")

                    //Evaluation iframe src
                    _this.url_Eval = _this.urlTemplate_Eval.replace("{{recordNumber}}",_this.evalId)
                    
                    //Employee-Input data
                    _this.getEmployeeInputId(_this.evalId,function(){
                        _this.getEmployeeInput(_this.employeeInputId, function(){
                            _this.getSupervisorLogsForPastYear(_this.evalId)
                        })
                    })
                },

                getUrlParameter: function(_name){
                    return decodeURIComponent((new RegExp('[?|&|]' + _name.toLowerCase() + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search.toLowerCase())||[,""])[1].replace(/\+/g, '%20'))||null;
                },

                getEmployeeInputId: function(_evalId, _callback){
                    var _this = this

                    //Reset variables
                    _this.employeeInputId = ""
                    _this.recordsAreLoading = true
                    _this.noRecordsFound = false
                    
                    axios.post('https://query.cityoflewisville.com/v2', {
                        webservice: "Evals_SelfAssessments_GetId",
                        auth_token: localStorage.colAuthToken,
                        evalid: _evalId
                    })
                    .then(function(_results){
                        console.group("getEmployeeInputId")  
                        console.log(_results.data)
                        console.groupEnd()
                        if (typeof _results.data[0][0] != 'undefined'){
                            _this.employeeInputId = _results.data[0][0].RecordNumber

                            //Execute callback
                            _callback()
                        }else{
                            _this.employeeInputId = ""
                            _this.noRecordsFound = true
                            _this.recordsAreLoading = false
                        }
                        _this.recordsAreLoading = false
                    })
                    .catch(function(error){ 
                        console.error(error)
                        _this.employeeInputId = ""
                        _this.noRecordsFound = true
                        _this.recordsAreLoading = false
                    })
                },

                getEmployeeInput: function(_employeeInputId, _callback){
                    var _this = this

                    axios.post('https://query.cityoflewisville.com/v2', {
                        webservice: "Evals_EmployeeInputForm_Get_ById",
                        auth_token: localStorage.colAuthToken,
                        recordnumber: _employeeInputId
                    })
                    .then(function(_results){  
                        console.group("getEmployeeInput")  
                        console.log(_results.data)
                        console.groupEnd()

                        if (typeof _results.data[0][0] != 'undefined'){
                            _this.employeeInput = _results.data[0][0] //first record only

                            //Execute callback
                            _callback()
                        }else{
                            _this.employeeInputId = ""
                            _this.noRecordsFound = true
                            _this.recordsAreLoading = false
                        }
                        _this.recordsAreLoading = false
                    })
                    .catch(function(error){ 
                        console.error(error)
                        _this.employeeInputId = ""
                        _this.noRecordsFound = true
                        _this.recordsAreLoading = false
                    })
                },
                getSupervisorLogsForPastYear: function(_evalId){
                    var _this = this

                    axios.post('https://query.cityoflewisville.com/v2', {
                        webservice: "Evals_SupervisorLogs_GetByEmployeeId",
                        auth_token: localStorage.colAuthToken,
                        evalid: _evalId
                    })
                    .then(function(_results){  
                        console.group("getSupervisorLogsForPastYear")  
                        console.log(_results.data)
                        console.groupEnd()

                        if (typeof _results.data[0][0] != 'undefined'){
                            _this.supervisorLogs = _results.data[0]
                        }else{
                            _this.employeeInputId = ""
                            _this.noRecordsFound = true
                            _this.recordsAreLoading = false
                        }
                        _this.recordsAreLoading = false
                    })
                    .catch(function(error){ 
                        console.error(error)
                        _this.employeeInputId = ""
                        _this.noRecordsFound = true
                        _this.recordsAreLoading = false
                    })
                }
            }
        });
        document.addEventListener('DOMContentLoaded', function(){
            app.init()
        })
        
    </script>
</body>
</html> 