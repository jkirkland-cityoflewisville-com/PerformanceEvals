<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">

    <title>Evaluation</title>
    <link rel="apple-touch-icon" sizes="180x180" href="../icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../icons/favicon-16x16.png">
    <link rel="manifest" href="../icons/site.webmanifest">
    <link rel="mask-icon" href="../icons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="../icons/favicon.ico">
    <meta name="msapplication-TileColor" content="#603cba">
    <meta name="msapplication-config" content="../icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!--Fonts-->
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

    <!--VueJS-->
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    
    <!-- axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <!--Security-->
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="../oauth/colsecurity.js""></script>

    <style>
        [v-cloak] {display: none}
        iframe {width:100%; height: calc(100vh - 250px);}
        table td{padding-top: 8px; padding-bottom: 8px;}
    </style>
</head>

<body style="background-color:whitesmoke;">
    
    <div id="app" v-cloak>
        <div class="navbar">
            <nav>
                <div class="nav-wrapper deep-purple white-text">
                    <a class="brand-logo">&nbsp Evaluation Forms</a>
                </div>
            </nav>       
        </div> <!--end navbar-->
       
        <!--Username-->
        <div class="row">
            <div class="col s12">
                {{(username.length == 0 ? "Getting username..." : username)}}
            </div>
        </div>
        

        <div class="main white">     
            
            <div class="row">
                
                <!--Employee-Input Form-->
                <div class="col s6">
                    <h5>Employee Input Form</h5>
                    <br>
                    <table style="margin-left: 1em;">
                        <tr><td><b>Evaluation_Period_Start_Date</b></td></tr>
                        <tr><td>{{employeeInput.Evaluation_Period_Start_Date}}</td></tr>

                        <tr><td><b>Evaluation_Period_End_Date</b></td></tr>
                        <tr><td>{{employeeInput.Evaluation_Period_End_Date}}</td></tr>

                        <tr><td><b>Question_Accomplishments_Past_Review_Period</b></td></tr>
                        <tr><td>{{employeeInput.Question_Accomplishments_Past_Review_Period}}</td></tr>

                        <tr><td><b>Question_Strengths_Opportunities</b></td></tr>
                        <tr><td>{{employeeInput.Question_Strengths_Opportunities}}</td></tr>

                        <tr><td><b>Question_Suggestions_Or_Comments</b></td></tr>
                        <tr><td>{{employeeInput.Question_Suggestions_Or_Comments}}</td></tr>

                        <tr><td><b>Question_What_Can_City_Do</b></td></tr>
                        <tr><td>{{employeeInput.Question_What_Can_City_Do}}</td></tr>

                        <tr><td><b>Question_Work_Challenges</b></td></tr>
                        <tr><td>{{employeeInput.Question_Work_Challenges}}</td></tr>
                    </table>
                </div>

                <!--Evaluation-->
                <div class="col s6" style="border-left: solid 1px black;">
                    <h5>Evaluation</h5>
                    <br>
                    <iframe :src="url_Eval"></iframe>
                </div>

            </div>

        </div> <!--end container-->

    </div>  <!--end app-->

    <!--=======================================================-->
    <!--Javascript-->
    <!--=======================================================-->
    <script>
        "use strict"

        var app = new Vue({
            el: "#app",
            data: {                
                username: "",
                evalId: "",
                employeeInputId: "",
                employeeInput: [],
                urlTemplate_Eval: "http://apps.cityoflewisville.com/gitlocal/christina/psofia_v2/formentry/index.html?formID=87&recordNumber={{recordNumber}}",
                url_Eval: "",
                urlTemplate_SA: "http://apps.cityoflewisville.com/gitlocal/christina/psofia_v2/formentry/index.html?formID=86&recordNumber={{recordNumber}}",
                url_SA: "",
                noRecordsFound: false,
                recordsAreLoading: false
            },
            methods: {

                init: function(){
                    var _this = this

                    //Oauth
                    setTimeout(function(){
                        _this.username = localStorage.colEmail
                    },1500)
                    
                    //Evaluation Id
                    _this.evalId = _this.getUrlParameter("recordNumber")

                    //Evaluation iframe src
                    _this.url_Eval = _this.urlTemplate_Eval.replace("{{recordNumber}}",_this.evalId)
                    
                    //Employee-Input data
                    _this.getEmployeeInputId(_this.evalId,function(){
                        _this.getEmployeeInput(_this.employeeInputId)
                    })
                },

                getUrlParameter: function(_name){
                    return decodeURIComponent((new RegExp('[?|&|]' + _name.toLowerCase() + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search.toLowerCase())||[,""])[1].replace(/\+/g, '%20'))||null;
                },

                getEmployeeInputId: function(_evalId, _callback){
                    var _this = this

                    //Reset variables
                    _this.employeeInputId = ""
                    _this.recordsAreLoading = true
                    _this.noRecordsFound = false
                    
                    axios.post('https://query.cityoflewisville.com/v2', {
                        webservice: "Evals_SelfAssessments_GetId",
                        auth_token: localStorage.colAuthToken,
                        evalid: _evalId
                    })
                    .then(function(_results){
                        console.group("getEmployeeInputId")  
                        console.log(_results.data)
                        console.groupEnd()
                        if (typeof _results.data[0][0] != 'undefined'){
                            _this.employeeInputId = _results.data[0][0].RecordNumber

                            //Execute callback
                            _callback()
                        }else{
                            _this.employeeInputId = ""
                            _this.noRecordsFound = true
                            _this.recordsAreLoading = false
                        }
                        _this.recordsAreLoading = false
                    })
                    .catch(function(error){ 
                        console.error(error)
                        _this.employeeInputId = ""
                        _this.noRecordsFound = true
                        _this.recordsAreLoading = false
                    })
                },

                getEmployeeInput: function(_employeeInputId){
                    var _this = this

                    axios.post('https://query.cityoflewisville.com/v2', {
                        webservice: "Evals_EmployeeInputForm_Get_ById",
                        auth_token: localStorage.colAuthToken,
                        recordnumber: _employeeInputId
                    })
                    .then(function(_results){  
                        console.group("getEmployeeInput")  
                        console.log(_results.data)
                        console.groupEnd()

                        if (typeof _results.data[0][0] != 'undefined'){
                            _this.employeeInput = _results.data[0][0] //first record only
                        }else{
                            _this.employeeInputId = ""
                            _this.noRecordsFound = true
                            _this.recordsAreLoading = false
                        }
                        _this.recordsAreLoading = false
                    })
                    .catch(function(error){ 
                        console.error(error)
                        _this.employeeInputId = ""
                        _this.noRecordsFound = true
                        _this.recordsAreLoading = false
                    })
                }
            }
        });
        document.addEventListener('DOMContentLoaded', function(){
            app.init()
        })
        
    </script>
</body>
</html> 